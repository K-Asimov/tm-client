name: Build and Release DMG

on:
  push:
    tags:
      - 'v*' # Triggered when a tag starting with 'v' is pushed (e.g., v1.0.0)

jobs:
  release:
    name: Build and Release
    runs-on: macos-15
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Xcode
        run: sudo xcode-select -s /Applications/Xcode_16.app

      - name: Build App
        run: |
          # Build the .app file in Release configuration
          xcodebuild -project TMClient.xcodeproj \
                     -scheme TMClientApp \
                     -configuration Release \
                     -derivedDataPath ./build \
                     clean build \
                     CODE_SIGN_IDENTITY="" \
                     CODE_SIGNING_REQUIRED=NO \
                     CODE_SIGNING_ALLOWED=NO

      - name: Prepare DMG
        run: |
          # Find the path of the built .app file
          APP_PATH=$(find ./build -name "TMClientApp.app" -type d | head -n 1)
          echo "APP_PATH=$APP_PATH" >> $GITHUB_ENV
          
          # Install create-dmg tool
          brew install create-dmg

      - name: Create DMG
        run: |
          # Remove existing dmg file if it exists
          rm -f TMClientApp.dmg
          
          # Create the dmg file (customizable design)
          create-dmg \
            --volname "TMClient Installation" \
            --window-pos 200 120 \
            --window-size 800 400 \
            --icon-size 100 \
            --icon "TMClientApp.app" 200 190 \
            --hide-extension "TMClientApp.app" \
            --app-drop-link 600 185 \
            "TMClientApp.dmg" \
            "${{ env.APP_PATH }}"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: TMClientApp.dmg
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
